// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Core Multi-tenancy and User Management
model Company {
  id          String   @id @default(cuid())
  name        String
  displayName String?
  email       String?
  phone       String?
  address     String?
  city        String?
  state       String?
  country     String?
  postalCode  String?
  taxId       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  branches    Branch[]
  users       CompanyUser[]
  customers   Customer[]
  vendors     Vendor[]
  vehicles    Vehicle[]
  drivers     Driver[]
  warehouses  Warehouse[]
  orders      Order[]
  trips       Trip[]
  invoices    Invoice[]
  tariffs     Tariff[]

  @@map("companies")
}

model Branch {
  id        String   @id @default(cuid())
  companyId String
  name      String
  code      String? @unique
  address   String?
  city      String?
  state     String?
  country   String?
  postalCode String?
  phone     String?
  email     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  warehouses Warehouse[]
  users      CompanyUser[]

  @@map("branches")
}

// User Management with Clerk Integration
model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  displayName String
  description String?
  permissions String   // JSON string of permissions
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  companyUsers CompanyUser[]

  @@map("roles")
}

model CompanyUser {
  id        String   @id @default(cuid())
  companyId String
  branchId  String?
  userId    String   // Clerk user ID
  roleId    String
  email     String
  name      String?
  phone     String?
  department String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  branch  Branch? @relation(fields: [branchId], references: [id], onDelete: SetNull)
  role    Role    @relation(fields: [roleId], references: [id])

  @@unique([companyId, userId])
  @@map("company_users")
}

// Master Data Management
model Customer {
  id          String   @id @default(cuid())
  companyId   String
  code        String? @unique
  name        String
  displayName String?
  email       String?
  phone       String?
  address     String?
  city        String?
  state       String?
  country     String?
  postalCode  String?
  taxId       String?
  creditLimit Float    @default(0)
  paymentTerms String?  // e.g., "NET30", "NET15"
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  company Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  orders  Order[]
  invoices Invoice[]

  @@map("customers")
}

model Vendor {
  id          String   @id @default(cuid())
  companyId   String
  code        String? @unique
  name        String
  displayName String?
  email       String?
  phone       String?
  address     String?
  city        String?
  state       String?
  country     String?
  postalCode  String?
  taxId       String?
  serviceTypes String   // JSON string of service types
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  company  Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  vehicles Vehicle[]
  drivers  Driver[]

  @@map("vendors")
}

model Location {
  id        String   @id @default(cuid())
  name      String
  code      String? @unique
  address   String?
  city      String?
  state     String?
  country   String?
  postalCode String?
  latitude  Float?
  longitude Float?
  type      String   // warehouse, port, airport, customer, etc.
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("locations")
}

model VehicleType {
  id           String   @id @default(cuid())
  name         String
  code         String? @unique
  description  String?
  capacityWeight Float?
  capacityVolume Float?
  capacityPallets Int?
  length       Float?
  width        Float?
  height       Float?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  vehicles Vehicle[]

  @@map("vehicle_types")
}

model Vehicle {
  id           String   @id @default(cuid())
  companyId    String
  vendorId     String?
  vehicleTypeId String
  registration String   @unique
  make         String?
  model        String?
  year         Int?
  vin          String? @unique
  capacityWeight Float?
  capacityVolume Float?
  capacityPallets Int?
  fuelType     String?
  isActive     Boolean  @default(true)
  fitnessExpiry DateTime?
  insuranceExpiry DateTime?
  permitExpiry DateTime?
  pollutionExpiry DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  company     Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  vendor      Vendor? @relation(fields: [vendorId], references: [id], onDelete: SetNull)
  vehicleType VehicleType @relation(fields: [vehicleTypeId], references: [id])
  trips       Trip[]
  maintenance VehicleMaintenance[]

  @@map("vehicles")
}

model Driver {
  id          String   @id @default(cuid())
  companyId   String
  vendorId    String?
  code        String? @unique
  name        String
  email       String?
  phone       String?
  licenseNo   String? @unique
  licenseExpiry DateTime?
  rating      Float?   @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  vendor  Vendor? @relation(fields: [vendorId], references: [id], onDelete: SetNull)
  trips   Trip[]

  @@map("drivers")
}

model Route {
  id          String   @id @default(cuid())
  origin      String
  destination String
  distance    Float?   // in km
  normalHours Float?   // normal transit time in hours
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([origin, destination])
  @@map("routes")
}

// Tariff Management
model Tariff {
  id          String   @id @default(cuid())
  companyId   String
  name        String
  description String?
  type        String   // lane_based, zone_based, weight_based
  validFrom   DateTime
  validTo     DateTime?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  company Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  slabs   TariffSlab[]
  accessorials AccessorialCharge[]

  @@map("tariffs")
}

model TariffSlab {
  id       String @id @default(cuid())
  tariffId String
  fromValue Float  // from weight/volume/distance
  toValue   Float? // to weight/volume/distance
  unitRate  Float  // rate per unit
  minCharge Float? // minimum charge
  isActive  Boolean @default(true)

  // Relations
  tariff Tariff @relation(fields: [tariffId], references: [id], onDelete: Cascade)

  @@map("tariff_slabs")
}

model AccessorialCharge {
  id          String   @id @default(cuid())
  tariffId    String
  name        String
  code        String?
  chargeType  String   // fixed, percentage
  amount      Float?
  percentage  Float?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tariff Tariff @relation(fields: [tariffId], references: [id], onDelete: Cascade)

  @@map("accessorial_charges")
}

// Order Management
model Order {
  id              String   @id @default(cuid())
  companyId       String
  customerId      String
  orderNo         String   @unique
  orderType       String   // FTL, LTL, PARCEL, CONTAINER, MULTIMODAL
  status          String   @default("DRAFT") // DRAFT, CONFIRMED, PLANNED, DISPATCHED, IN_TRANSIT, DELIVERED, POD_RECEIVED, CLOSED
  priority        String   @default("NORMAL") // LOW, NORMAL, HIGH, URGENT
  
  // Addresses
  shipperName     String?
  shipperAddress  String?
  shipperCity     String?
  shipperState    String?
  shipperCountry  String?
  shipperPostalCode String?
  shipperPhone    String?
  
  consigneeName   String?
  consigneeAddress String?
  consigneeCity   String?
  consigneeState  String?
  consigneeCountry String?
  consigneePostalCode String?
  consigneePhone  String?
  
  // Delivery requirements
  pickupDate      DateTime?
  deliveryDate    DateTime?
  pickupTimeFrom  String?
  pickupTimeTo    String?
  deliveryTimeFrom String?
  deliveryTimeTo  String?
  
  // Goods details
  totalWeight     Float    @default(0)
  totalVolume     Float    @default(0)
  totalValue      Float    @default(0)
  packageCount    Int      @default(0)
  description     String?
  specialHandling String   // JSON string of special handling requirements
  deliveryInstructions String?
  
  // Financial
  declaredValue   Float    @default(0)
  freightCharge   Float    @default(0)
  totalCharges    Float    @default(0)
  
  // Metadata
  createdBy       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  company   Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer  Customer    @relation(fields: [customerId], references: [id])
  items     OrderItem[]
  trips     Trip[]
  invoices  InvoiceLine[]
  trackingEvents TrackingEvent[]

  @@map("orders")
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  sku         String?
  description String
  quantity    Int
  weight      Float    @default(0)
  volume      Float    @default(0)
  value       Float    @default(0)
  hsnCode     String?
  isHazardous Boolean  @default(false)
  isFragile   Boolean  @default(false)
  isTempControlled Boolean @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_items")
}

// Transportation Management
model Trip {
  id              String   @id @default(cuid())
  companyId       String
  orderIds     String   // JSON string of order IDs
  tripNo          String   @unique
  vehicleId       String?
  driverId        String?
  status          String   @default("PLANNED") // PLANNED, DISPATCHED, IN_TRANSIT, DELIVERED, COMPLETED, CANCELLED
  priority        String   @default("NORMAL")
  
  // Route information
  origin          String?
  destination     String?
  distance        Float?   // in km
  estimatedHours  Float?   // estimated transit time
  
  // Schedule
  plannedDeparture DateTime?
  actualDeparture  DateTime?
  plannedArrival   DateTime?
  actualArrival    DateTime?
  
  // Financial
  estimatedCost    Float    @default(0)
  actualCost       Float    @default(0)
  
  // Metadata
  createdBy        String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  vehicle Vehicle? @relation(fields: [vehicleId], references: [id])
  driver  Driver?  @relation(fields: [driverId], references: [id])
  orders  Order[]
  events  TrackingEvent[]
  documents Document[]

  @@map("trips")
}

model TrackingEvent {
  id          String   @id @default(cuid())
  orderId     String?
  tripId      String?
  eventType   String   // DEPARTED, ARRIVED, LOADED, UNLOADED, DELAYED, BREAKDOWN, etc.
  location    String?
  description String?
  timestamp   DateTime @default(now())
  createdBy   String?
  latitude    Float?
  longitude   Float?

  // Relations
  order Order? @relation(fields: [orderId], references: [id], onDelete: Cascade)
  trip  Trip?  @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@map("tracking_events")
}

// Warehouse Management
model Warehouse {
  id          String   @id @default(cuid())
  companyId   String
  branchId    String?
  name        String
  code        String? @unique
  address     String?
  city        String?
  state       String?
  country     String?
  postalCode  String?
  warehouseType String? // distribution_center, fulfillment_center, cross_dock, cold_storage
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  branch  Branch? @relation(fields: [branchId], references: [id], onDelete: SetNull)
  locations WarehouseLocation[]
  inventory Inventory[]
  transactions InventoryTransaction[]

  @@map("warehouses")
}

model WarehouseLocation {
  id          String   @id @default(cuid())
  warehouseId String
  code        String? @unique
  zone        String?
  aisle       String?
  rack        String?
  level       String?
  position    String?
  locationType String? // storage, picking, receiving, shipping
  capacityWeight Float?
  capacityVolume Float?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  inventory Inventory[]
  transactions InventoryTransaction[]

  @@map("warehouse_locations")
}

model SKU {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String?
  category    String?
  weight      Float    @default(0)
  volume      Float    @default(0)
  hsnCode     String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  inventory Inventory[]
  transactions InventoryTransaction[]

  @@map("skus")
}

model Inventory {
  id              String   @id @default(cuid())
  warehouseId     String
  locationId      String?
  skuId           String
  batchNo         String?
  lotNo           String?
  serialNo        String?
  expiryDate      DateTime?
  quantity        Float    @default(0)
  reservedQty     Float    @default(0)
  availableQty    Float    @default(0)
  status          String   @default("AVAILABLE") // AVAILABLE, RESERVED, DAMAGED, QUARANTINE
  lastCountedAt   DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  warehouse Warehouse       @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  location  WarehouseLocation? @relation(fields: [locationId], references: [id], onDelete: SetNull)
  sku       SKU             @relation(fields: [skuId], references: [id])

  @@unique([warehouseId, locationId, skuId, batchNo])
  @@map("inventory")
}

model InventoryTransaction {
  id              String   @id @default(cuid())
  warehouseId     String
  locationId      String?
  skuId           String
  transactionType String   // INBOUND, OUTBOUND, TRANSFER, ADJUSTMENT, CYCLE_COUNT
  quantity        Float
  referenceNo     String?  // GRN, Order No, etc.
  referenceType   String?  // ORDER, TRANSFER, etc.
  reason          String?
  createdBy       String?
  createdAt       DateTime @default(now())

  // Relations
  warehouse Warehouse       @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  location  WarehouseLocation? @relation(fields: [locationId], references: [id], onDelete: SetNull)
  sku       SKU             @relation(fields: [skuId], references: [id])

  @@map("inventory_transactions")
}

// Billing and Finance
model Invoice {
  id              String   @id @default(cuid())
  companyId       String
  customerId      String
  invoiceNo       String   @unique
  invoiceDate     DateTime
  dueDate         DateTime?
  status          String   @default("DRAFT") // DRAFT, SENT, PAID, PARTIALLY_PAID, OVERDUE, CANCELLED
  subtotal        Float    @default(0)
  taxAmount       Float    @default(0)
  totalAmount     Float    @default(0)
  paidAmount      Float    @default(0)
  balanceAmount   Float    @default(0)
  currency        String   @default("USD")
  notes           String?
  createdBy       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  company Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer Customer    @relation(fields: [customerId], references: [id])
  lines   InvoiceLine[]

  @@map("invoices")
}

model InvoiceLine {
  id          String   @id @default(cuid())
  invoiceId   String
  orderId     String?
  description String
  quantity    Float    @default(1)
  unitRate    Float    @default(0)
  amount      Float    @default(0)
  taxRate     Float    @default(0)
  taxAmount   Float    @default(0)
  totalAmount Float    @default(0)
  createdAt   DateTime @default(now())

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  order   Order?  @relation(fields: [orderId], references: [id])

  @@map("invoice_lines")
}

// Fleet Management
model VehicleMaintenance {
  id          String   @id @default(cuid())
  vehicleId   String
  type        String   // PREVENTIVE, CORRECTIVE, EMERGENCY
  description String?
  cost        Float    @default(0)
  odometer    Float?
  performedBy String?
  performedAt DateTime?
  nextDueAt   DateTime?
  status      String   @default("SCHEDULED") // SCHEDULED, IN_PROGRESS, COMPLETED, CANCELLED
  notes       String?
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@map("vehicle_maintenance")
}

model FuelEntry {
  id          String   @id @default(cuid())
  vehicleId   String
  driverId    String?
  date        DateTime
  odometer    Float?
  quantity    Float    // in liters/gallons
  unitPrice   Float    @default(0)
  totalCost   Float    @default(0)
  fuelType    String?
  location    String?
  receiptNo   String?
  notes       String?
  createdBy   String?
  createdAt   DateTime @default(now())

  @@map("fuel_entries")
}

// Document Management
model Document {
  id          String   @id @default(cuid())
  entityId    String   // Can reference Order, Trip, Invoice, etc.
  entityType  String   // ORDER, TRIP, INVOICE, POD, etc.
  documentType String  // POD, WAYBILL, INVOICE, CONTRACT, etc.
  fileName    String
  filePath    String
  fileSize    Int?
  mimeType    String?
  uploadedBy  String?
  createdAt   DateTime @default(now())

  // Relations
  trips Trip[]

  @@map("documents")
}

// System Configuration
model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("system_configs")
}